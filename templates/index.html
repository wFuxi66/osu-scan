<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>osu!scan</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            text-align: center;
            background: #16213e;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            /* Better for mobile */
            margin: 0 auto;
        }

        /* Mobile Adjustments */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            input[type="text"] {
                width: 100%;
                /* Full width on mobile */
                box-sizing: border-box;
                /* Include padding in width */
            }

            .mode-selection {
                padding-left: 0;
                display: inline-flex;
                /* Robust centering */
                width: auto;
                margin: 25px 0;
                align-items: flex-start;
            }
        }

        .logo {
            max-width: 200px;
            /* Adjust size as needed */
            margin-bottom: 20px;
        }

        h1 {
            display: none;
            /* Hide text h1 */
            margin-bottom: 20px;
            color: #ff66aa;
        }

        input[type="text"] {
            padding: 12px;
            width: 250px;
            border-radius: 6px;
            border: 1px solid #0f3460;
            background: #0f3460;
            color: white;
            font-size: 16px;
        }

        button {
            padding: 12px 24px;
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            /* margin-left: 10px; Removed to center properly */
            width: 100%;
            /* Make buttons full width for better alignment */
            max-width: 200px;
            /* Limit max width */
        }

        button:hover {
            background-color: #ff2e63;
        }

        .error {
            color: #ff6b6b;
            margin-top: 15px;
        }

        /* New styles for mode selection and progress */
        .mode-selection {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 25px;
            margin-bottom: 25px;
            text-align: left;
            padding-left: 50px;
        }

        /* ... (radio styles unchanged) ... */

        .hidden {
            display: none !important;
        }

        /* Progress Container styling */
        #progress {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            /* Stack spinner, text, button */
            align-items: center;
            /* Center everything */
            gap: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e94560;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        #progress p {
            margin: 0;
            font-size: 16px;
            color: #4facfe;
        }

        .cancel-btn {
            background-color: #2c3e50;
            /* Darker/Neutral for cancel */
            border: 1px solid #4facfe;
            margin-left: 0;
        }

        .cancel-btn:hover {
            background-color: #34495e;
            border-color: #e94560;
        }

        /* Ko-fi Support Button */
        .kofi-btn {
            display: inline-block;
            background: linear-gradient(135deg, #ff66aa 0%, #e94560 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(233, 69, 96, 0.3);
            margin-left: 8px;
        }

        .kofi-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.5);
            background: linear-gradient(135deg, #ff7ab8 0%, #ff2e63 100%);
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('scanForm');
            const progressDiv = document.getElementById('progress');
            const statusText = document.getElementById('status-text');
            const scanBtn = document.getElementById('scanBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const errorMsg = document.getElementById('error-msg');

            let currentJobId = null;
            let isCancelled = false;
            let pollInterval = null;

            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const usernameInput = document.getElementById('username-input');
                    const username = usernameInput ? usernameInput.value : '';
                    const modeInput = document.querySelector('input[name="mode"]:checked');
                    const mode = modeInput ? modeInput.value : 'gd';

                    if (!username) {
                        alert("Please enter a username or ID");
                        return;
                    }

                    // Reset UI
                    scanBtn.classList.add('hidden');
                    progressDiv.classList.remove('hidden');
                    statusText.textContent = "Initializing...";

                    isCancelled = false;
                    cancelBtn.disabled = false;
                    cancelBtn.textContent = "Cancel Scan";
                    if (errorMsg) errorMsg.style.display = 'none';

                    if (pollInterval) clearInterval(pollInterval);

                    try {
                        const formData = new FormData();
                        formData.append('username', username);
                        formData.append('mode', mode);

                        const startRes = await fetch('/api/start_scan', {
                            method: 'POST',
                            body: formData
                        });

                        if (!startRes.ok) {
                            throw new Error("Start Failed: " + startRes.statusText);
                        }

                        const startData = await startRes.json();

                        if (startData.error) {
                            alert(startData.error);
                            resetUI();
                            return;
                        }

                        currentJobId = startData.job_id;
                        pollStatus(currentJobId);

                    } catch (err) {
                        console.error(err);
                        alert("Network error starting scan: " + err.message);
                        resetUI();
                    }
                });
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', async () => {
                    if (!currentJobId) return;
                    if (confirm("Stop scan?")) {
                        cancelBtn.disabled = true;
                        isCancelled = true;
                        statusText.textContent = "Cancelling...";
                        try {
                            await fetch(`/api/cancel_scan/${currentJobId}`, { method: 'POST' });
                        } catch (e) { console.error(e); }
                        finally {
                            setTimeout(() => { if (isCancelled) resetUI(); }, 1000);
                        }
                    }
                });
            }

            function pollStatus(jobId) {
                if (isCancelled) return;

                pollInterval = setInterval(async () => {
                    if (isCancelled) {
                        clearInterval(pollInterval);
                        resetUI();
                        return;
                    }

                    try {
                        const res = await fetch(`/api/status/${jobId}`);

                        if (res.status === 404) {
                            clearInterval(pollInterval);
                            alert("Job lost (Server Restarted). Please try again.");
                            resetUI();
                            return;
                        }

                        if (!res.ok) {
                            return;
                        }

                        const data = await res.json();

                        if (data.status === 'running') {
                            statusText.textContent = data.message;
                        } else if (data.status === 'done') {
                            clearInterval(pollInterval);
                            window.location.href = `/results_view/${jobId}`;
                        } else if (data.status === 'cancelled') {
                            clearInterval(pollInterval);
                            statusText.textContent = "Cancelled.";
                            setTimeout(resetUI, 1500);
                        } else if (data.status === 'error') {
                            clearInterval(pollInterval);
                            alert("Error: " + data.error);
                            resetUI();
                        }

                    } catch (err) {
                        console.error(err);
                    }
                }, 1000);
            }

            function resetUI() {
                if (scanBtn) {
                    scanBtn.disabled = false;
                    scanBtn.classList.remove('hidden');
                }
                if (progressDiv) progressDiv.classList.add('hidden');
                currentJobId = null;
                isCancelled = false;
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
            }
        });
    </script>
</head>

<body>
    <div class="container">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="osu!scan" class="logo">
        <h1>osu!scan</h1>
        <p style="font-size: 14px; color: #aeb2b8; margin-bottom: 25px;">
            Check who made the most gd in your maps, which mapper you made the most gd for, who nominated most of your
            maps and which mappers an individual bn nominated the most!
        </p>
        <form id="scanForm">
            <input type="text" id="username-input" name="username" placeholder="Username or ID" required>

            <!-- Mode Selection -->
            <div class="mode-selection">
                <label>
                    <input type="radio" name="mode" value="gd" checked>
                    <span>Top GDer in my maps</span>
                </label>
                <label>
                    <input type="radio" name="mode" value="gd_hosts">
                    <span>Top Mapper I made GD for</span>
                </label>
                <label>
                    <input type="radio" name="mode" value="nominators">
                    <span>Top BN that nominated my maps</span>
                </label>
                <label>
                    <input type="radio" name="mode" value="bn">
                    <span>Top Favorite Mapper for a BN</span>
                </label>
            </div>

            <button type="submit" id="scanBtn">Start Scan</button>
        </form>

        <div id="progress" class="hidden">
            <div class="spinner"></div>
            <p id="status-text">Starting scan...</p>
            <button id="cancelBtn" class="cancel-btn">Cancel Scan</button>
        </div>

        <div style="margin-top: 40px; font-size: 12px; color: #666;">
            Made by <a href="https://osu.ppy.sh/users/24230576"
                style="color: #ff66aa; text-decoration: none;">Fuxi66</a>
            • Data from <a href="https://osu.ppy.sh" style="color: #ff66aa; text-decoration: none;">osu!</a>
            • <a href="https://ko-fi.com/fuxi66" target="_blank" class="kofi-btn">Support ☕</a>
        </div>
    </div>
</body>

</html>